<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.2" />






<meta name="description" content="Read Theplant Blog TechForce: A case study of RedisRedis is one of the open source projects I’m currently most interested in.As a key-value store, Redis has the abillity to store data via its datatyp">
<meta property="og:type" content="article">
<meta property="og:title" content="case-of-study-for-redis">
<meta property="og:url" content="http://shaorui23.github.io/2013/04/22/case-of-study-for-redis/index.html">
<meta property="og:site_name" content="Eric&#39;s Blog">
<meta property="og:description" content="Read Theplant Blog TechForce: A case study of RedisRedis is one of the open source projects I’m currently most interested in.As a key-value store, Redis has the abillity to store data via its datatyp">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="http://theplant.jp/system/photos/bgwekoq0t9.png?1345691160">
<meta property="og:image" content="http://theplant.jp/system/photos/p2smz2953a.png?1345692049">
<meta property="og:image" content="http://theplant.jp/system/photos/f1y1xkk5fc.png?1345692207">
<meta property="og:updated_time" content="2017-08-29T15:33:54.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="case-of-study-for-redis">
<meta name="twitter:description" content="Read Theplant Blog TechForce: A case study of RedisRedis is one of the open source projects I’m currently most interested in.As a key-value store, Redis has the abillity to store data via its datatyp">
<meta name="twitter:image" content="http://theplant.jp/system/photos/bgwekoq0t9.png?1345691160">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://shaorui23.github.io/2013/04/22/case-of-study-for-redis/"/>





  <title>case-of-study-for-redis | Eric's Blog</title>
  














</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Eric's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://shaorui23.github.io/2013/04/22/case-of-study-for-redis/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Eric Wang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://avatars1.githubusercontent.com/u/672563?v=3&s=460">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Eric's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">case-of-study-for-redis</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2013-04-22T23:33:09+08:00">
                2013-04-22
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2013/04/22/case-of-study-for-redis/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2013/04/22/case-of-study-for-redis/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p><span itemprop="articleBody"></span></p>
<p>Read <a href="http://theplant.jp/en/blogs/12-techforce-a-case-study-of-redis" target="_blank" rel="external">Theplant Blog</a></p>
<h2 id="TechForce-A-case-study-of-Redis"><a href="#TechForce-A-case-study-of-Redis" class="headerlink" title="TechForce: A case study of Redis"></a><a href="#TechForce-A-case-study-of-Redis" title="TechForce: A case study of Redis"></a>TechForce: A case study of Redis</h2><p><code>Redis</code> is one of the open source projects I’m currently most interested in.As a key-value store, Redis has the abillity to store data via its datatypes. In this article I will try to show the process of how we design and implement a simple clone of Twitter written using Ruby and Redis as only database.</p>
<p>Here is a screenshot of the application:</p>
<p><img src="http://theplant.jp/system/photos/bgwekoq0t9.png?1345691160" alt=""></p>
<p>Our Twitter case is structurally simple. It mainly contains three features for the user: add friends, remove friends and post a tweet. We have only five people in our “world” and each person can get others’ tweets by adding them as friends.</p>
<p>Through this simple application, we will learn how to construct a key and use appropriate data types to store values.</p>
<p>Now, let me walk you through the main concepts of this application.</p>
<h2 id="RubyGem-about-Redis"><a href="#RubyGem-about-Redis" class="headerlink" title="RubyGem about Redis"></a><a href="#RubyGem-about-Redis" title="RubyGem about Redis"></a>RubyGem about Redis</h2><p>In this application, I use “redis-rb” gem, a Ruby client library for<br>Redis, to match Redis’ API one-to-one while still providing an idiomatic<br>interface. It features thread-safety, client-side sharding, pipelining,<br>and an obsession for performance. Here’s the link to visit this project: [Redis][<a href="https://github.com/redis/redis-rb" target="_blank" rel="external">https://github.com/redis/redis-rb</a>]</p>
<p>You can connect to Redis by instantiating the ‘Redis’ class:</p>
<pre><code>require  &quot;redis&quot;
redis = Redis.new(:host =&gt; &quot;127.0.0.1&quot;, :port =&gt; 6379)
</code></pre><h2 id="Data-Structure"><a href="#Data-Structure" class="headerlink" title="Data Structure"></a><a href="#Data-Structure" title="Data Structure"></a>Data Structure</h2><p>Design a table to store values is easy for a relational database. But We don’t have tables now, so we should designed structure to store a value and identify what keys are needed to represent our objects.</p>
<p>Let’s start from Users. We need to represent these users of course, with the username, userid, followers and following users, and so on. Like relational databases, it’s a good solution to associate a unique ID to every user to identify users inside our system. Every other reference to this user will be made by id.</p>
<pre><code>INCR UserID =&gt; 1000
SET user:id:1000:username theplant
SET username:theplant:user:id 1000
</code></pre><h3 id="The-core-code-for-constructing-Users"><a href="#The-core-code-for-constructing-Users" class="headerlink" title="The core code for constructing Users:"></a><a href="#The-core-code-for-constructing-Users" title="The core code for constructing Users:"></a>The core code for constructing Users:</h3><pre><code>def init_user(redis)
  redis.set(&quot;user:uid&quot;, 1000)
  username = %W[Eric Yuan Binku Lancee Juice]
  username.each do |name|
    user_id = Redis.current.incr(&quot;user:uid&quot;) 
    redis.set(&quot;user:id:#{user_id}:username&quot;, name)
    redis.set(&quot;username:#{name}:user:id&quot;, user_id)
    redis.rpush(&quot;users&quot;, user_id)
  end
end
</code></pre><h2 id="Following-followers"><a href="#Following-followers" class="headerlink" title="Following, followers"></a><a href="#Following-followers" title="Following, followers"></a>Following, followers</h2><p>Redis data type “Set” is a perfect data structure to save these values. Every user has followers and users that they are following.</p>
<pre><code>User:id:1000:followers =&gt; Set of ids of followers of current user
User:id:1000:following =&gt; Set of ids of followees of current user
</code></pre><h2 id="The-core-code-for-the-above"><a href="#The-core-code-for-the-above" class="headerlink" title="The core code for the above:"></a><a href="#The-core-code-for-the-above" title="The core code for the above:"></a>The core code for the above:</h2><pre><code>def add_friend
  redis.sadd(&quot;user:id:#{params[:self_id]}:followees&quot;, params[:followee_id])
  redis.sadd(&quot;user:id:#{params[:followee_id]}:followers&quot;, params[:self_id] )
end
</code></pre><h2 id="Post"><a href="#Post" class="headerlink" title="Post"></a><a href="#Post" title="Post"></a>Post</h2><p>The most important part of our case is to add the post to every user and display it in the user’s page. Not only saving your own posts but also getting your friends’ tweets on your page. Using the same strategy for saving User data, we also associate a unique ID to every user to identify users inside our system.</p>
<pre><code>INCR post:id =&gt; 1
SET post:1 &quot;My first tweet!&quot;
</code></pre><p>Then we use the Redis data type “List” to save every post_id. Introduction from reids.io:</p>
<blockquote>
<p>Redis Lists are simply lists of strings, sorted by insertion order. It is possible to add elements to a Redis List pushing new elements on the head (on the left) or on the tail (on the right) of the list.</p>
</blockquote>
<pre><code>$ user:id:1000:posts =&gt; List of post ids
</code></pre><p>The core code:</p>
<pre><code>def add_post
  redis = Redis.current
  post_id = redis.incr(&quot;Post:Id&quot;)
  redis.set(&quot;post:#{post_id}&quot;, params[:post])
  redis.rpush(&quot;posts&quot;, post_id)
  redis.sadd(&quot;user:id:#{params[:id]}:posts&quot;, post_id)
  redis.smembers(&quot;user:id:#{params[:id]}:followers&quot;).each do |follower|
    redis.sadd(&quot;user:id:#{follower}:mentions&quot;, post_id)
  end
end
</code></pre><p><img src="http://theplant.jp/system/photos/p2smz2953a.png?1345692049" alt=""></p>
<h2 id="Following-users"><a href="#Following-users" class="headerlink" title="Following users"></a><a href="#Following-users" title="Following users"></a>Following users</h2><p>There are more than Lists. Redis also supports Sets that are unsorted collections of elements. It is possible to add, remove, and test for the existence of members and perform intersections between different Sets. If user id 1000 (Eric) wants to follow user id 1001 (Yuan), we can do this with just two SADD:</p>
<pre><code>SADD user:id:1000:following 1001
SADD user:id:1001:followers 1000
</code></pre><p>And remove a friend is much like to following a user. It should be pointed out that we will lose a follower when your follower “removes” you. The core code below:</p>
<pre><code>def remove_friend
  redis.srem(&quot;user:id:#{params[:self_id]}:followees&quot;, params[:follower_id])
  redis.srem(&quot;user:id:#{params[:follower_id]}:followers&quot;, params[:self_id])
  remove_ids= redis.smembers(&quot;user:id:#{params[:follower_id]}:posts&quot;)
  remove_ids.each do |id|
    redis.srem(&quot;user:id:#{params[:self_id]}:mentions&quot;, id) 
  end
end
</code></pre><p>Here is a screenshot of string value we save in Redis:</p>
<p><img src="http://theplant.jp/system/photos/f1y1xkk5fc.png?1345692207" alt=""></p>
<p><code>TechForce</code> is a weekly meeting held at The Plant for developers to present and discuss new technologies and projects they are working on. Each week a different developer presents.</p>
<p>]</p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2011/10/21/服装企业需求调研的几点总结/服装企业需求调研的几点总结/" rel="next" title="服装企业需求调研的几点总结">
                <i class="fa fa-chevron-left"></i> 服装企业需求调研的几点总结
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div class="ds-thread" data-thread-key="2013/04/22/case-of-study-for-redis/"
           data-title="case-of-study-for-redis" data-url="http://shaorui23.github.io/2013/04/22/case-of-study-for-redis/">
      </div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="https://avatars1.githubusercontent.com/u/672563?v=3&s=460"
               alt="Eric Wang" />
          <p class="site-author-name" itemprop="name">Eric Wang</p>
           
              <p class="site-description motion-element" itemprop="description">Focus</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives/">
                <span class="site-state-item-count">3</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          

          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#TechForce-A-case-study-of-Redis"><span class="nav-number">1.</span> <span class="nav-text">TechForce: A case study of Redis</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#RubyGem-about-Redis"><span class="nav-number">2.</span> <span class="nav-text">RubyGem about Redis</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Data-Structure"><span class="nav-number">3.</span> <span class="nav-text">Data Structure</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#The-core-code-for-constructing-Users"><span class="nav-number">3.1.</span> <span class="nav-text">The core code for constructing Users:</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Following-followers"><span class="nav-number">4.</span> <span class="nav-text">Following, followers</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#The-core-code-for-the-above"><span class="nav-number">5.</span> <span class="nav-text">The core code for the above:</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Post"><span class="nav-number">6.</span> <span class="nav-text">Post</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Following-users"><span class="nav-number">7.</span> <span class="nav-text">Following users</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Eric Wang</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Muse
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.2"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.2"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.2"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"shaorui23"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
    
    <script src="/lib/ua-parser-js/dist/ua-parser.min.js?v=0.7.9"></script>
    <script src="/js/src/hook-duoshuo.js"></script>
  














  





  

  

  

  

  

  

</body>
</html>
